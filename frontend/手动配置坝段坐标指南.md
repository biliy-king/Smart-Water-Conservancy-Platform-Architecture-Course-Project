# 手动配置坝段坐标指南

## 📍 坐标格式说明

### 基本格式
每个坝段需要定义一个**多边形**（至少3个顶点），坐标格式为：
```javascript
[经度, 纬度, 高度(米)]
```

### 可以画什么形状？
✅ **可以画不规则多边形**（推荐）
- 至少需要 **3个顶点**
- 可以画任意形状：三角形、四边形、五边形等
- 最后一个顶点会自动连接到第一个顶点，形成闭合多边形

✅ **也可以画规则矩形**（简单情况）
- 4个顶点形成一个矩形

## 🎯 完整配置示例

### 示例1：规则矩形（4个顶点）

```javascript
const segmentBounds = [
  // 坝段 0 - 矩形
  [
    [111.15, 30.80, 50],  // 左上角
    [111.16, 30.80, 50],  // 右上角
    [111.16, 30.79, 50],  // 右下角
    [111.15, 30.79, 50]   // 左下角
  ],
  
  // 坝段 1 - 矩形
  [
    [111.16, 30.80, 50],
    [111.17, 30.80, 50],
    [111.17, 30.79, 50],
    [111.16, 30.79, 50]
  ],
  
  // ... 继续定义其他9个坝段
];
```

### 示例2：不规则多边形（5个顶点）

```javascript
const segmentBounds = [
  // 坝段 0 - 不规则五边形
  [
    [111.15, 30.80, 50],  // 点1
    [111.155, 30.805, 50], // 点2
    [111.16, 30.80, 50],  // 点3
    [111.16, 30.79, 50],  // 点4
    [111.15, 30.79, 50]   // 点5
  ],
  
  // ... 其他坝段
];
```

### 示例3：三角形（3个顶点）

```javascript
const segmentBounds = [
  // 坝段 0 - 三角形
  [
    [111.15, 30.80, 50],  // 顶点1
    [111.16, 30.80, 50],  // 顶点2
    [111.155, 30.79, 50]  // 顶点3
  ],
  
  // ... 其他坝段
];
```

## 🔧 如何获取坐标？

### 方法1：使用坐标拾取工具（推荐）

1. **打开浏览器控制台**（F12）

2. **运行以下代码**：
```javascript
// 方法1：使用全局函数（推荐，最简单）
window.startCoordinatePicker()

// 方法2：手动获取 viewer（如果方法1不工作）
const cesiumRef = window.cesiumSceneRef()
const viewer = cesiumRef?.getViewer()
const Cesium = window.Cesium

if (!viewer || !Cesium) {
  console.error('无法获取 viewer 或 Cesium，请确保页面已加载');
  console.log('💡 提示：请等待页面完全加载（约3-5秒）后再试');
} else {
  // 开始坐标拾取
  const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
  let coordinates = [];
  let segmentIndex = 0;
  
  handler.setInputAction((click) => {
    const position = viewer.scene.pickPosition(click.position);
    if (Cesium.defined(position)) {
      const cartographic = Cesium.Cartographic.fromCartesian(position);
      const lon = Cesium.Math.toDegrees(cartographic.longitude);
      const lat = Cesium.Math.toDegrees(cartographic.latitude);
      const height = cartographic.height;
      
      coordinates.push([lon, lat, height]);
      console.log(`📍 坝段 ${segmentIndex} - 已记录坐标 ${coordinates.length}: [${lon.toFixed(6)}, ${lat.toFixed(6)}, ${height.toFixed(2)}]`);
      
      // 每收集完一个坝段的坐标，输出
      if (coordinates.length >= 3) {
        console.log(`\n✅ 坝段 ${segmentIndex} 的坐标数组（至少3个点，可以继续点击添加更多点）：`);
        console.log(JSON.stringify(coordinates, null, 2));
        console.log('\n💡 提示：继续点击可以添加更多点，或按 Enter 键完成当前坝段');
      }
    } else {
      console.warn('⚠️ 未拾取到坐标，请点击模型表面');
    }
  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
  
  // 按 Enter 键完成当前坝段，开始下一个
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && coordinates.length >= 3) {
      console.log(`\n🎯 坝段 ${segmentIndex} 完成！坐标数组：`);
      console.log(JSON.stringify(coordinates, null, 2));
      console.log(`\n继续点击模型为坝段 ${segmentIndex + 1} 拾取坐标...`);
      coordinates = [];
      segmentIndex++;
    }
  });
  
  console.log('✅ 坐标拾取器已启动');
  console.log('📝 点击模型上的点来记录坐标');
  console.log('⌨️  按 Enter 键完成当前坝段，开始下一个坝段');
  console.log('🛑 调用 handler.destroy() 停止拾取');
  
  // 保存 handler 到全局，方便停止
  window.coordinatePickerHandler = handler;
}
```

3. **使用步骤**：
   - 点击模型上的点，会在控制台输出坐标
   - 至少点击3个点形成一个多边形
   - 可以继续点击添加更多点（形成不规则多边形）
   - 按 **Enter 键**完成当前坝段，开始下一个坝段
   - 重复11次，收集完所有坝段的坐标

4. **停止拾取**：
```javascript
window.coordinatePickerHandler.destroy();
```

### 方法2：使用 Cesium Inspector

1. 在控制台运行：
```javascript
viewer.extend(Cesium.viewerInspectorMixin);
```

2. 在 Cesium Inspector 面板中查看坐标信息

## 📝 如何应用配置？

### 步骤1：收集完所有坐标后

将所有11个坝段的坐标整理成数组格式（见上面的示例）

### 步骤2：在浏览器控制台运行

```javascript
// 定义11个坝段的边界坐标
const segmentBounds = [
  // 坝段 0
  [[111.15, 30.80, 50], [111.16, 30.80, 50], [111.16, 30.79, 50], [111.15, 30.79, 50]],
  // 坝段 1
  [[111.16, 30.80, 50], [111.17, 30.80, 50], [111.17, 30.79, 50], [111.16, 30.79, 50]],
  // ... 继续添加其他9个坝段
];

// 应用配置
window.setupMask(segmentBounds, true);  // 第二个参数 true 表示开启调试模式（显示红色热区）
```

### 步骤3：查看效果

- 如果开启了调试模式，会看到红色半透明的热区
- 点击热区，应该能高亮对应的坝段
- 如果位置准确，关闭调试模式：
```javascript
window.cesiumSceneRef().setMaskConfig({
  debugMode: false  // 关闭调试模式，热区变为完全透明
});
```

## 💡 实用技巧

### 1. 如何确定需要多少个点？

- **规则矩形**：4个点（4个角）
- **不规则形状**：根据实际边界，至少3个点，建议4-8个点
- **复杂边界**：可以添加更多点来精确描述边界

### 2. 高度值怎么确定？

- 如果所有点在同一高度，使用相同的高度值
- 如果大坝有坡度，可以给不同点设置不同的高度
- 建议先使用相同高度，如果效果不对再调整

### 3. 坐标精度

- 经度和纬度建议保留 **6位小数**（约0.1米精度）
- 高度建议保留 **2位小数**（米）

### 4. 验证配置

配置完成后，开启调试模式查看热区位置：
```javascript
window.cesiumSceneRef().setMaskConfig({
  debugMode: true  // 显示红色热区
});
```

如果位置不对，可以：
- 重新拾取坐标
- 手动微调坐标值
- 添加或删除顶点

## ⚠️ 注意事项

1. **顶点顺序**：建议按顺时针或逆时针顺序排列顶点
2. **闭合多边形**：最后一个顶点会自动连接到第一个顶点
3. **至少3个顶点**：每个坝段至少需要3个顶点
4. **11个坝段**：需要定义11个坝段（索引0-10）
5. **坐标系统**：使用 WGS84 坐标系（经度、纬度、高度）

## 🎯 完整工作流程

1. ✅ 打开页面，等待模型加载完成
2. ✅ 在控制台运行坐标拾取工具代码
3. ✅ 点击模型上的点，收集每个坝段的坐标
4. ✅ 按 Enter 键完成当前坝段，继续下一个
5. ✅ 收集完11个坝段的坐标
6. ✅ 整理成 `segmentBounds` 数组格式
7. ✅ 调用 `window.setupMask(segmentBounds, true)` 应用配置
8. ✅ 查看红色热区位置是否正确
9. ✅ 如果正确，关闭调试模式：`debugMode: false`
10. ✅ 测试点击热区是否能正确高亮坝段

## 📞 遇到问题？

- 如果拾取不到坐标：确保点击的是模型表面，不是空白处
- 如果热区位置不对：重新拾取坐标或手动调整
- 如果点击热区没反应：检查是否启用了蒙版模式（`enabled: true`）
