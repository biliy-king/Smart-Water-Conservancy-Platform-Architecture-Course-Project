# 大坝分段蒙版热区配置说明

## 概述

蒙版热区系统通过在模型表面创建不可见的几何体（多边形）作为"热区"，点击热区时触发对应坝段的高亮。这种方法适合需要精确手动划分区域的场景。

## 当前实现方式说明

### 1. **几何划分法**（当前默认）
- 自动计算模型边界
- 沿主要方向（X/Y/Z轴）均匀划分
- 通过坐标范围判断分段
- **优点**：无需手动配置，自动适应
- **缺点**：只适用于规则模型，精度可能不够

### 2. **蒙版热区法**（新增）
- 手动定义每个坝段的边界坐标
- 创建不可见的多边形作为热区
- 点击热区时直接识别坝段
- **优点**：精确控制，适合不规则模型
- **缺点**：需要手动配置坐标

## 使用方法

### 方法一：手动配置边界坐标（推荐）

在父组件中调用 `setMaskConfig` 方法：

```javascript
// 在 SceneView.vue 或其他父组件中
const cesiumSceneRef = ref(null);

// 配置蒙版
cesiumSceneRef.value.setMaskConfig({
  enabled: true,  // 启用蒙版模式
  debugMode: true,  // 开启调试模式（显示红色热区边界，方便调整）
  totalSegments: 11,  // 11个坝段（0-10）
  segmentBounds: [
    // 坝段 0 的边界坐标（世界坐标：经度、纬度、高度）
    [
      [111.15, 30.80, 50],  // 顶点1
      [111.16, 30.80, 50],  // 顶点2
      [111.16, 30.79, 50],  // 顶点3
      [111.15, 30.79, 50]   // 顶点4（形成闭合多边形）
    ],
    // 坝段 1 的边界坐标
    [
      [111.16, 30.80, 50],
      [111.17, 30.80, 50],
      [111.17, 30.79, 50],
      [111.16, 30.79, 50]
    ],
    // ... 继续定义其他9个坝段的边界
    // 坝段 2-10 的配置...
  ]
});
```

### 方法二：自动生成（基于几何划分法）

如果不想手动配置，可以自动生成：

```javascript
// 先确保模型边界已计算
cesiumSceneRef.value.calculateModelBounds();

// 然后自动生成蒙版热区
cesiumSceneRef.value.setMaskConfig({
  enabled: true,
  debugMode: true,  // 开启调试模式查看生成的热区
  totalSegments: 11
  // 不提供 segmentBounds，会自动调用 createMaskEntitiesAuto()
});
```

## 如何获取边界坐标？

### 方法1：使用 Cesium Inspector（推荐）

1. 在浏览器控制台运行：
```javascript
viewer.extend(Cesium.viewerInspectorMixin);
```

2. 在 Cesium 场景中：
   - 使用鼠标选择模型上的点
   - 查看 Inspector 面板中的坐标信息
   - 记录每个坝段的边界点坐标

### 方法2：使用调试模式

1. 先使用自动生成功能：
```javascript
cesiumSceneRef.value.setMaskConfig({
  enabled: true,
  debugMode: true,  // 显示红色热区
  totalSegments: 11
});
cesiumSceneRef.value.createMaskEntitiesAuto();
```

2. 在场景中查看自动生成的热区位置
3. 如果位置不对，可以：
   - 在控制台查看热区的坐标
   - 手动调整坐标值
   - 重新配置

### 方法3：使用点击获取坐标

在控制台运行以下代码，点击模型时会输出坐标：

```javascript
const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
handler.setInputAction((click) => {
  const position = viewer.scene.pickPosition(click.position);
  if (Cesium.defined(position)) {
    const cartographic = Cesium.Cartographic.fromCartesian(position);
    const lon = Cesium.Math.toDegrees(cartographic.longitude);
    const lat = Cesium.Math.toDegrees(cartographic.latitude);
    const height = cartographic.height;
    console.log(`坐标: [${lon.toFixed(6)}, ${lat.toFixed(6)}, ${height.toFixed(2)}]`);
  }
}, Cesium.ScreenSpaceEventType.LEFT_CLICK);
```

## 配置示例

### 完整配置示例

```javascript
// 假设大坝沿经度方向（X轴）分布，从 111.15 到 111.25
// 每个坝段宽度约 0.01 度（约1.1公里）

const segmentBounds = [];

for (let i = 0; i < 11; i++) {
  const startLon = 111.15 + i * 0.01;
  const endLon = 111.15 + (i + 1) * 0.01;
  const lat1 = 30.80;  // 上边界纬度
  const lat2 = 30.79;  // 下边界纬度
  const height = 50;   // 高度（米）
  
  segmentBounds.push([
    [startLon, lat1, height],  // 左上
    [endLon, lat1, height],    // 右上
    [endLon, lat2, height],    // 右下
    [startLon, lat2, height]   // 左下
  ]);
}

cesiumSceneRef.value.setMaskConfig({
  enabled: true,
  debugMode: true,  // 先开启调试模式查看效果
  totalSegments: 11,
  segmentBounds: segmentBounds
});
```

## API 参考

### setMaskConfig(config)

设置蒙版配置。

**参数：**
- `config.enabled` (boolean): 是否启用蒙版模式
- `config.debugMode` (boolean): 是否显示热区边界（调试用）
- `config.totalSegments` (number): 总段数（默认11）
- `config.segmentBounds` (Array): 手动定义的坝段边界坐标数组

### createMaskEntitiesFromConfig(boundsConfig)

根据手动配置创建蒙版热区。

**参数：**
- `boundsConfig` (Array): 边界配置数组，格式见上文

### createMaskEntitiesAuto()

自动生成蒙版热区（基于几何划分法）。

### clearMaskEntities()

清除所有蒙版热区。

## 调试技巧

1. **开启调试模式**：设置 `debugMode: true`，热区会显示为红色半透明，方便查看位置
2. **调整坐标**：如果热区位置不对，可以：
   - 查看控制台输出的坐标信息
   - 手动调整 `segmentBounds` 中的坐标值
   - 重新调用 `setMaskConfig`
3. **测试点击**：点击热区时，控制台会输出 "点击蒙版热区：坝段 X"

## 注意事项

1. **坐标格式**：使用世界坐标（WGS84），格式为 `[经度, 纬度, 高度(米)]`
2. **多边形闭合**：最后一个顶点会自动连接到第一个顶点，形成闭合多边形
3. **至少3个顶点**：每个坝段至少需要3个顶点才能形成多边形
4. **高度一致**：建议同一坝段的所有顶点使用相同的高度值
5. **性能考虑**：11个热区对性能影响很小，但如果模型很大，建议优化热区数量

## 切换模式

```javascript
// 切换到蒙版模式
cesiumSceneRef.value.setMaskConfig({ enabled: true });

// 切换回几何划分法
cesiumSceneRef.value.setMaskConfig({ enabled: false });
```
